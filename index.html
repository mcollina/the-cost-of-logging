<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>The Cost of Logging</title>
    <link rel="stylesheet" type="text/css" href="build/build.css">
  </head>
  <body>
    <article>
      <section data-bespoke-backdrop="pines" class="transwhite">
        <div style="text-align: left; margin-top: -2em;">
          <h1>The Cost of Logging</h1>
          <h3>by&nbsp;<a href="http://twitter.com/matteocollina">@matteocollina</a></h3>
          <h3 style="margin-left:.15em;margin-top: -1em">&&nbsp;&nbsp;<a style="display:inline-block;margin-left: -.03em" href="http://twitter.com/davidmarkclem">@davidmarkclem</a></h3><br><a href="http://nearform.com" style="width: 50%; float: right; margin-bottom: -30em;"><img src="./images/nearform.svg"></a>
        </div>
      </section>
      <section data-bespoke-backdrop="london" class="trans">
        <h2 style="margin-left: 50%; text-align: right; width: 30%">Our story begins in London</h2>
      </section>
      <section data-bespoke-backdrop="nap-mp" class="trans">
        <h2 style="color: #eee; padding-left: 40%; padding-bottom: 50%">NET-A-PORTER <br> & <br> MR-PORTER</h2><a style="color: black; display: block; white-space: nowrap; line-height: 0.5em; padding: 0.5em; padding-bottom: 0.7em; background: rgba(255,255,255,0.8) !important; border-radius: 3px" href="http://www.nearform.com/nodecrunch/client-case-study-net-a-porter/">http://www.nearform.com/nodecrunch/client-case-study-net-a-porter</a>
      </section>
      <section>
        <h2>Results</h2><br><img src="./images/barchart.png" style="height: 70%">
      </section>
      <section>
        <h1>Observation</h1>
        <h2>Disabling logging</h2>
        <h2>increased throughput</h2>
      </section>
      <section><img src="./images/bugfix.svg" style="width: 90%"></section>
      <section>
        <h2>The more you log the better</h2><img src="./images/shifu.png" style="margin-bottom: -1%">
      </section>
      <section>
        <h2>Perceived time spent<br>logging a line</h2>
        <h1>0 ms</h1>
      </section>
      <section>
        <h2>Actual time spent<br>logging a line</h2>
        <h1>0.22 ms</h1>
        <!-- node is single threaded!-->
      </section>
      <section>
        <h2 style="margin-bottom: 1.25em;margin-top: -.5em;position:relative;">One Log Per Request</h2><img src="images/0.22ms-2kreq-1log.png" style="height:90%;margin-left:12%;margin-top: -7.5%;margin-bottom:-5%">
      </section>
      <section>
        <h2 style="margin-bottom: 1.25em;margin-top: -.5em;position:relative;">Ten Logs Per Request</h2><img src="images/0.22ms-2kreq-10logs.png" style="height:90%;margin-left:5%;margin-top: -5%;margin-bottom:-5%">
      </section>
      <section><img src="./images/kaboom.gif"></section>
      <section data-bespoke-backdrop="snail" class="trans">
        <h1 style="color: white; margin-left: -10%; margin-right: auto; width: 10%; text-align: left; padding-bottom: 5%">Why so slow?</h1>
      </section>
      <section data-bespoke-backdrop="adapters" class="trans">
        <h2 style="margin-left:-30%">Adapters</h2>
        <h2>of adapters</h2>
        <h2 style="margin-left:25%">of adapters</h2>
        <h2 style="margin-left:50%; font-size: 1em">of adapters</h2>
        <h2 style="margin-left:75%; font-size: 0.5em">of adapters</h2>
        <h2 style="margin-left:90%; font-size: 0.2em">of adapters</h2>
      </section>
      <section data-bespoke-backdrop="lamp" class="trans">
        <h1 style="color: white; margin-left: -10%; margin-right: auto; width: 10%; text-align: left; padding-bottom: 5%">Idea</h1>
      </section>
      <section data-bespoke-backdrop="lamp" class="trans">
        <h2 style="color: white; margin-left: auto; margin-right: 0%; width: 30%; text-align: right; padding-bottom: 5%">Let's write a <u><i>fast</i></u> logger!</h2>
      </section>
      <section><img src="./images/pino.png" style="width: 90%"></section>
      <section>
        <h1>We</h1>
        <h1 style="color: red;font-size: 7em;margin-bottom: .25em">â™¥</h1>
        <h1>JSON <span style='color: red'>\n</span></h1>
      </section>
      <section>
        <pre><code class="language-javascript">const split = require('split2')
process.stdin.pipe(split(JSON.parse))
  .on('data', (obj) => {
    console.log(Object.keys(obj))
  })</code></pre><br><img src="./images/split2.png">
      </section>
      <section>
        <h1>Pino</h1>
        <h2>Bunyan API</h2>
      </section>
      <section>
        <pre><code class="language-javascript">const pino = require('pino')()
pino.info('hello world')
pino.debug({
  big: 'object'
}, 'with message')
</code></pre>
      </section>
      <section>
        <h1>Pino</h1>
        <h2>10000 ops â€” 250ms</h2>
      </section>
      <section>
        <h2 style="margin-bottom: 1.25em;margin-top: -.5em;position:relative;">One Log Per Request</h2><img src="images/0.025ms-2kreq-1log.png" style="height:90%;margin-left:10%;margin-top: -7.5%;margin-bottom:-5%">
      </section>
      <section>
        <h2 style="margin-bottom: 1.25em;margin-top: -.5em;position:relative;">Ten Logs Per Request</h2><img src="images/0.025ms-2kreq-10logs.png" style="height:90%;margin-left:10%;margin-top: -7.5%;margin-bottom:-5%">
      </section>
      <section><img src="./images/bench-basic.svg" style="height: 95%"></section>
      <section data-bespoke-backdrop="extreme" style="color: white" class="trans">
        <div style="text-align: right">
          <h1>Extreme Mode</h1>
          <h2>We can go faster</h2>
        </div>
      </section>
      <section>
        <h1>Extreme Mode</h1>
        <h2>10000 logs in 100ms</h2>
        <h2>2x throughput increase</h2>
      </section>
      <section>
        <h2 style="margin-bottom: 1.25em;margin-top: -.5em;position:relative;">Ten Logs Per Request</h2><img src="images/0.01ms-2kreq-10logs.png" style="height:90%;margin-left:10%;margin-top: -7.5%;margin-bottom:-5%">
      </section>
      <section>
        <h1>Extreme Mode</h1>
        <h2>Trade-off: 4k batching</h2>
      </section>
      <section>
        <pre><code class="language-javascript">const pino = require('pino')({
  extreme: true
})
pino.info('hello world')
pino.debug({
  big: 'object'
}, 'with message')
</code></pre>
      </section>
      <section data-bespoke-backdrop="integration" class="trans">
        <!-- big thing to just do a shadow-->
        <h1 style="color: white; text-shadow: -2px 0 1px black, 0 2px 1px black, 2px 0 1px black, 0 -2px 1px black;">Server Integration</h1>
      </section>
      <section>
        <h1 style="position:absolute;top:0;width:100%;text-align:center;left:0;font-size: 3.5em">Express</h1><code style="margin-top: 2.5em;margin-bottom: -.25em" class="language-bash">&nbsp;$ npm install express-pino-logger&nbsp;</code>
        <pre><code style="position:relative; top:-1em" class="language-javascript">var app = require('express')()
var pino = require('express-pino-logger')()

app.use(pino)

app.get('/', function (req, res) {
  req.log.info('something else')
  res.send('hello world')
})

app.listen(3000)
</code></pre>
      </section>
      <section>
        <h1>Hapi</h1><code class="language-bash">&nbsp;$ npm install hapi-pino&nbsp;</code>
        <pre><code class="language-javascript">const Hapi = require('hapi')
const server = new Hapi.Server()
server.connection({
  host: 'localhost',
  port: 3000
})
</code></pre>
      </section>
      <section>
        <h1>Hapi</h1><code class="language-bash">&nbsp;$ npm install hapi-pino&nbsp;</code>
        <pre><code class="language-javascript">server.register({
  register: require('hapi-pino').register
}, (err) => {
  if (err) { return console.error(err) }
  server.logger().info('log from server instance')
  server.start()
})
</code></pre>
      </section>
      <section>
        <h1>Hapi</h1><code class="language-bash">&nbsp;$ npm install hapi-pino&nbsp;</code>
        <pre><code class="language-javascript">server.route({
  method: 'GET',
  path: '/',
  handler: function (request, reply) {
    request.log(['a', 'b'], 'Request into hello world')
    request.logger.info('In handler %s', request.path)
    return reply('hello world')
  }
})

</code></pre>
      </section>
      <section>
        <h1 style="position:absolute;top:0;width:100%;text-align:center;left:0;font-size: 3.5em">Restify</h1><code style="margin-top: 2.5em;margin-bottom: -.25em" class="language-bash"> &nbsp;$ npm install restify-pino-logger&nbsp;</code>
        <pre><code style="position:relative; top:-1em" class="language-javascript">var restify = require('restify')
var server = restify.createServer({name: 'app'})

server.use(require('restify-pino-logger')())

server.get('/', function (req, res) {
  req.log.info('something else')
  res.send('hello world')
})

server.listen(3000)
</code></pre>
      </section>
      <section>
        <h1 style="position:absolute;top:0;width:100%;text-align:center;left:0;font-size: 3.5em">Koa</h1><code style="margin-top: 2.5em;margin-bottom: -.25em" class="language-bash">  &nbsp;$ npm install koa-pino-logger&nbsp;</code>
        <pre><code style="position:relative; top:-1em" class="language-javascript">var Koa = require('koa')
var logger = require('koa-pino-logger')
var app = new Koa()
app.use(logger())
app.use((ctx) => {
  ctx.log.info('something else')
  ctx.body = 'hello world'
})
app.listen(3000)
</code></pre>
      </section>
      <section>
        <h1 style="position:absolute;top:0;width:100%;text-align:center;left:0;font-size: 3.5em">http</h1><code style="margin-top: 2.5em;margin-bottom: -.25em" class="language-bash">&nbsp;$ npm install pino-http&nbsp;</code>
        <pre><code style="position:relative; top:-1em" class="language-javascript">var http = require('http')
var server = http.createServer(handle)
var logger = require('pino-http')()
function handle (req, res) {
  logger(req, res)
  req.log.info('something else')
  res.end('hello world')
}
server.listen(3000)

</code></pre>
      </section>
      <section data-bespoke-backdrop="dragon-scroll" class="trans">
        <h1 style="color: white; padding-top: 50%">Secret Sauce(s)</h1>
      </section>
      <section>
        <h1>Secret Sauce</h1>
        <h2>Avoid JSON.stringify</h2>
      </section>
      <section>
        <h1>Secret Sauce</h1>
        <h2>Date.now()<br>vs<br>new Date().toISOString()</h2>
      </section>
      <section>
        <h1>Secret Sauce</h1>
        <h2 style="margin-bottom: .5em">%FlattenString</h2><code class="language-bash">&nbsp;$ npm install flatstr&nbsp;</code>
      </section>
      <section>
        <pre><code class="language-javascript">module.exports = function flatstr (s) {
  Number(s)
  return s
}
</code></pre>
      </section>
      <section>
        <h1>Secret Sauce</h1>
        <h2 style="margin-bottom: .5em">fast-safe-stringify</h2><code class="language-bash">&nbsp;$ npm install fast-safe-stringify&nbsp;</code>
      </section>
      <section>
        <pre><code class="language-javascript">function Circle (val, k, parent) {
  this.val = val
  this.k = k
  this.parent = parent
}
Circle.prototype.toJSON = function toJSON () {
  this.parent[this.k] = this.val
  return '[Circular]'
}
</code></pre>
      </section>
      <section>
        <h1>Secret Sauce</h1>
        <h2 style="margin-bottom: .5em">quick-format</h2><code class="language-bash">&nbsp;$ npm install quick-format&nbsp;</code>
      </section>
      <section data-bespoke-backdrop="tools" class="trans">
        <h1 style="color: white;margin-top: -40%">Tools <br>of the Trade</h1>
      </section>
      <section data-bespoke-backdrop="fire" class="trans">
        <h2 style="color: white; text-shadow: -2px 0 1px black, 0 2px 1px black, 2px 0 1px black, 0 -2px 1px black;">Flamegraphs
          <!-- a flamegraph visualizes functions in such a way that-->
          <!-- it shows you which ones are taking up the most time-->
        </h2>
      </section>
      <section>
        <h1 style="margin-top:-.5em">0x</h1>
        <p style="padding:0;margin:0;margin-top: -1em;margin-bottom:.5em"><code class="language-bash">&nbsp;$ npm install 0x&nbsp;</code></p><img src="images/0x-demo.gif" style="height:85%">
      </section>
      <section><img src="images/pr.png" style="height:90%"><br><a href="https://github.com/mcollina/pino/pull/2">https://github.com/mcollina/pino/pull/2</a></section>
      <section>
        <h2>Before</h2><img src="images/fg-pino-before.png" style="width: 95%">
      </section>
      <section>
        <h2>After</h2><img src="images/fg-pino-after.png" style="width: 95%">
      </section>
      <section><img src="images/autocannon.png" style="width:100%;margin-bottom:5%;margin-top:-5%">
        <h3>HTTP load tester</h3>
        <h3>Trival cross platform installation</h3>
        <h3>Generates 10% more load than alternatives in C</h3>
      </section>
      <section>
        <h2 style="font-size: 3.125em">0x + autocannon = ðŸ‘Œ</h2>
      </section>
      <section>
        <h2 style="font-size: 3.125em">Demo</h2>
      </section>
      <section data-bespoke-backdrop="wv" class="trans">
        <h2 style="margin-top: -20%">Pino is more than module</h2>
      </section>
      <section data-bespoke-backdrop="wv" class="trans">
        <h2 style="margin-top: -20%">Pino is a way of life</h2>
        <!-- because it is not only a tool, it encourages you-->
        <!-- down a path that leads to performant programming-->
        <!-- and avoid the pitfalls of the adapter problem-->
      </section>
      <section>
        <h1>Pino Philosophy</h1>
        <h2>Absolute minimum overhead</h2>
      </section>
      <section>
        <h1>Pino Philosophy</h1>
        <h2>Rotate your logs yourself!</h2>
      </section>
      <section>
        <h1>Pino Philosophy</h1>
        <h2>Want better readability? Post-process</h2>
        <h3>With <code>pino</code> CLI</h3>
      </section>
      <section>
        <h1>Pino Philosophy</h1>
        <h2>Transports are separate processes</h2>
      </section>
      <section>
        <h2>Demo: ELK Integration</h2>
        <p><a href="https://github.com/mcollina/pino-elasticsearch" style="white-space: nowrap;">https://github.com/mcollina/pino-elasticsearch</a></p>
      </section>
      <section data-bespoke-backdrop="ecosystem-impact" class="trans">
        <h2 style="margin-top: -20%; color: white; text-shadow: 0px 0px 4px black">Ecosystem Impact</h2>
      </section>
      <section>
        <h2>This presentation</h2>
        <ul class="bullet">
          <li><a href="https://mcollina.github.io/the-cost-of-logging">https://mcollina.github.io/the-cost-of-logging</a></li>
          <li><a href="https://github.com/mcollina/the-cost-of-logging">
              https://github.com/mcollina/the-cost-of-logging
              </a></li>
        </ul>
      </section>
      <section><img src="images/matteo.png" style="width: 95%">
        <h3><a href="http://github.com/mcollina">http://github.com/mcollina</a></h3>
      </section>
      <section><img src="images/dave.png" style="width: 95%">
        <h3><a href="http://github.com/davidmarkclements">http://github.com/davidmarkclements</a></h3>
      </section>
      <section>
        <h1>Thanks!</h1><a href="http://nearform.com" style="width: 20%"><img src="./images/nearform.svg"></a><br>
        <h3><a href="mailto:matteo.collina@nearform.com">matteo.collina@nearform.com</a></h3>
        <h3><a href="mailto:david.clements@nearform.com">david.clements@nearform.com</a></h3>
        <h3><a href="http://twitter.com/matteocollina">@matteocollina</a> <a href="http://twitter.com/davidmarkclem">@davidmarkclem</a></h3>
        <h3><a href="http://www.nearform.com">www.nearform.com</a></h3>
      </section>
    </article>
    <script src="build/build.js"></script>
  </body>
</html>